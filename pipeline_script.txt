#!/bin/bash

# defining file paths as variables for simpler use later in the script
fastqdir=/localdisk/data/BPSM/AY21/fastq
Tcongo_genome=/localdisk/data/BPSM/AY21/Tcongo_genome/TriTrypDB-46_TcongolenseIL3000_2019_Genome.fasta.gz
bedfile=/localdisk/data/BPSM/AY21/TriTrypDB-46_TcongolenseIL3000_2019.bed

#for fastq_file in $fastqdir/*fq.gz
#do
# fastqc is running but either very slowly or quickly and with errors. Doesn't make it the whole way.
# also still need to think how I interpret the output to give the user something informative.
#fastqc -o fastqc_outputs $fastq_file &
#done
 

# create bowtie2 index database for the T. congolense reference genome
#bowtie2-build $Tcongo_genome Tcongo_indexed_genome

# iterate over all pairs of fastq files
for fastq_1_file in $fastqdir/*1.fq.gz
do
fastq_2_file=`echo $fastq_1_file | sed 's/_1/_2/'`

# map each pair of reads to the bowtie index database for the T. congolense reference genome 
#bowtie2 -x Tcongo_indexed_genome -q -1 $fastq_1_file -2 $fastq_2_file -S ${fastq_1_file:32:-8}.sam

# convert sam file from bowtie2 output to a bam file
#samtools view -b -S ${fastq_1_file:32:-8}.sam > ${fastq_1_file:32:-8}.bam
#samtools sort ${fastq_1_file:32:-8}.bam -o ${fastq_1_file:32:-8}.sorted.bam
#samtools index ${fastq_1_file:32:-8}.sorted.bam

# count the reads using bedtools multicov. -D means includes duplicate reads
#bedtools multicov -D -bams ${fastq_1_file:32:-8}.sorted.bam -bed $bedfile > ${fastq_1_file:32:-8}.counts

done

# Now need to generate groups from the sample info file.

# Removing old groups 
rm *group.txt
IFS=$'\t'
while read id sample replicate time treatment end1 end2
do
if test $sample == "Clone1" && test $time == "0" 
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone1_0_group.txt
fi
if test $sample == Clone2 && test $time == 0 
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone2_0_group.txt
fi
if test $sample == WT && test $time == 0 
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> wt_0_group.txt
fi
if test $sample == Clone1 && test $time == 24 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone1_24_unind_group.txt
fi
if test $sample == Clone2 && test $time == 24 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone2_24_unind_group.txt
fi
if test $sample == WT && test $time == 24 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> wt_24_unind_group.txt
fi
if test $sample == Clone1 && test $time == 48 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone1_48_unind_group.txt
fi
if test $sample == Clone2 && test $time == 48 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone2_48_unind_group.txt
fi
if test $sample == WT && test $time == 48 && test $treatment == Uninduced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> wt_48_unind_group.txt
fi
if test $sample == Clone1 && test $time == 24 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone1_24_ind_group.txt
fi
if test $sample == Clone2 && test $time == 24 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone2_24_ind_group.txt
fi
if test $sample == WT && test $time == 24 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> wt_24_ind_group.txt
fi
if test $sample == Clone1 && test $time == 48 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone1_48_ind_group.txt
fi
if test $sample == Clone2 && test $time == 48 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> clone2_48_ind_group.txt
fi
if test $sample == WT && test $time == 48 && test $treatment == Induced
then echo -e "$id\t$sample\t$replicate\t$time\t$treatment\t$end1\t$end2" >> wt_48_ind_group.txt
fi
done < "/localdisk/data/BPSM/AY21/fastq/100k.fqfiles" 

# aim to create bedtools multicov outputs for all groups
# looping over all the 15 groups
for group_file in clone2_24_unind_group.txt
do
echo $group_file
bam_file_array=()
sample_count=0
sample_count_array=()
while read id sample replicate time treatment end1 end2
do
# add the bam files for the samples in the group to an array
for bam_file in *.sorted.bam
do
if test ${end1::13} == ${bam_file::13}
then
bam_file_array+=($bam_file)
sample_count=$((sample_count+1))
sample_count_array+=("r$sample_count")
echo ${sample_count_array[*]}
fi
done
# use the array as input to the bedtools multicov. Sample reads will appear in columns in the same file making determining their mean much easier.
bedtools multicov -bams ${bam_file_array[*]} -bed $bedfile > ${group_file::-4}.counts.tsv

# find the mean of the read data for the groups and paste these into a new file with just the gene names and descriptions
while read f1 f2 f3 gene_name gene_description ${sample_count_array[*]}
do 
total=0
for i in "${sample_count_array[@]}"
do
total=$((total+$i))
done
mean=$(($total/${#sample_count_array[@]}))
echo -e "$gene_name\t$gene_description\t$mean" >> ${group_file::-4}.mean.counts.tsv
done < ${group_file::-4}.counts.tsv 
done < $group_file
done

